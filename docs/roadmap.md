# Marionet 开发路线图

> 精简版路线图 | 快速查看进度和设计方向

- **状态**：快速原型阶段
- **当前阶段**: Phase 1.5 - 渲染层完善  
- **最后更新**: 2025-10-25
- **版本**: v0.0.9-alpha-2025/10/24-stable
- **已知问题**：https://github.com/MarionetLab/Marionet/issues
- **Github 项目看板**：https://github.com/orgs/MarionetLab/projects/2
- **设计完整度**: 75% | **实现进度**: 5%
- **项目定位**: 桌面陪伴应用

## 📚 快速导航

- [Phase 1.5 完成清单](PHASE_1.5_COMPLETION_CHECKLIST.md) - 当前阶段详细检查清单
- [渲染层完整性检查](design/rendering-layer-checklist.md) - 功能完整性评估
- [技术设计文档索引](design/README.md) - 所有设计文档目录
- [编码规范](CODING_STANDARDS.md) - 代码风格指南

---

## 阶段概览

```
Phase 1 (已完成) → Phase 1.5 (进行中) → Phase 2 (规划) → Phase 3 (规划) → Phase 4 (规划)
 基础渲染          渲染完善        Context基础     动作序列交互    高级功能优化
```

**架构核心**: Context 模块 (记忆-决策循环)  
**设计参考**: 架构图（见上方）

---

## Phase 1: 渲染引擎基础

**状态**: 已完成  
**目标**: 建立可运行的 Live2D 渲染框架

### 完成项
- Godot 4.5 + GDCubism 集成
- Live2D 模型加载和渲染
- 窗口透明、点击穿透、拖动
- 服务定位器模式
- 基础动画播放
- 眼部跟踪鼠标

### 技术栈确定
- 引擎: Godot 4.5 (.NET)
- 语言: GDScript + C#
- 渲染: Live2D Cubism SDK（主要）+ 多渲染器支持（规划）
- 平台: Windows (首要支持)

### 渲染架构与许可证策略

**项目定位**：
- Marionet 是**桌面陪伴游戏/应用**，而非内容创作工具
- 类比：《模拟人生》、《上古卷轴》等游戏 + DLC 模式
- 用户通过 DLC 获得新角色，通过 MOD 扩展功能

**渲染器支持规划**：

| 渲染类型 | 状态 | 许可证 | 说明 |
|---------|------|--------|------|
| **Live2D** | ✅ Phase 1 已实现 | Live2D 专有 | 高质量 2D 动画，主要渲染方案 |
| **2D Sprite** | 🔄 Phase 2 规划 | 完全免费 | 简单桌宠，降级/免费方案 |
| **VRM (3D)** | 🔮 Phase 3+ 规划 | 开源（MIT） | 3D 虚拟形象，VTuber 标准 |
| **Spine** | 🔮 Phase 4+ 可选 | Spine 专有 | 2D 骨骼动画 |
| **Godot 3D** | 🔮 Phase 4+ 可选 | MIT | 自定义 3D 场景 |

**许可证合规策略**：
- **框架本身**：Apache 2.0，完全开源
- **Live2D 许可**：归类为"游戏/应用程序"（非可扩展性应用）
- **角色 DLC**：预制内容包（`.dlc` 格式），制作者负责模型许可
- **功能 MOD**：仅扩展逻辑功能，不涉及 Live2D 内容创建
- **用户限制**：不提供模型导入接口，只能加载预制 DLC

**关键设计边界**：
- ✅ 允许：加载预制角色 DLC、功能扩展 MOD、配置编辑
- ❌ 不允许：导入任意 Live2D 模型、创建新角色、模型编辑器
- ✅ 目标：作为游戏/应用，避免被判定为"可扩展性应用"

> 详细许可证说明：[LICENSE.md](../LICENSE.md) | [LICENSE.zh-CN.md](../LICENSE.zh-CN.md)

---

## Phase 1.5: 渲染层完善

**状态**: 进行中 (设计阶段 85% 完成)  
**目标**: 完善 Live2D 渲染层核心功能，打好基础，预留扩展接口  
**预计工时**: 7 周（1.5-2 个月）

### 📋 核心任务概览

| 模块 | 状态 | 优先级 | 设计文档 |
|------|------|--------|---------|
| 对话文字渲染 | 设计完成 | P0 | [dialogue-rendering-system.md](design/dialogue-rendering-system.md) |
| 口型同步 | 设计完成 | P0 | [lip-sync-system.md](design/lip-sync-system.md) |
| 深度触摸交互 | 设计完成 | P0 | [deep-interaction-system.md](design/deep-interaction-system.md) |
| 自动眨眼/呼吸 |  已实现 | P0 | 使用 GDCubism 组件 |
| 错误恢复 | 待实现 | P1 | [performance-and-stability.md](design/performance-and-stability.md) |
| 人物配置 | 规划中 | P1 | [character-config-system.md](design/character-config-system.md) |

> 详细完成标准和检查清单: [PHASE_1.5_COMPLETION_CHECKLIST.md](PHASE_1.5_COMPLETION_CHECKLIST.md)

### P0 - 渲染核心
- HitArea 检测问题 #2 (Ready, Size: S)
  - 精确的点击区域检测
  - 支持点击身体区域的判定
  - 透明度判定优化
  - 性能优化
  - 运行测试
- GDCubism 插件功能拓展 #3 (Backlog, Size: S)
  - 扩展插件能力
  - 与 Godot 深度集成
- 基础点击事件传递 #9 (Backlog, Size: S)
  - 事件系统完善
  - 交互响应优化
- **物理效果确认与配置**
  - 确认 GDCubism Physics 是否默认启用
  - 添加物理效果开关（头发/衣服摆动）
  - 配置物理参数（重力/阻尼）
- **模型资源管理优化**
  - 模型资源预加载（避免切换卡顿）
  - 内存管理优化（切换时释放旧资源）
  - 资源懒加载机制
- **API文档更新** 
### P0 - Live2D 动画系统增强
- ~~**自动眨眼系统**~~ ✅ **已实现！**
  - GDCubismEffectEyeBlink 已挂载在场景中
  - 当前状态：眨眼功能正常，但间隔可能较规律
  - **可选优化（P1）**：添加随机间隔配置（如果需要）
- ~~**呼吸动画系统**~~ ✅ **已实现！**
  - GDCubismEffectBreath 已挂载在场景中
  - Idle 时自动产生呼吸起伏效果
  - **可选优化（P1）**：调整呼吸频率和幅度参数
- **动画混合与过渡**
  - 动画淡入淡出（避免跳变）
  - 表情混合支持
  - 可配置过渡时间
  - GDCubism 参数优化
- **动画队列系统（可选）**
  - 多个动画排队播放
  - 动画完成回调事件
  - 队列优先级管理
  - 与行为调度器集成接口
- **点击反馈动画**
  - 点击 HitArea 时播放特定动画/表情
  - 可配置不同部位的反馈
  - 反馈动画库管理

> 详细设计文档: `docs/design/animation-enhancement-system.md`（待创建）

### P0 - 交互系统
- 悬浮球/启动窗交互系统 #8 (Backlog, Size: M)
  - 悬浮窗样式设计
  - 快捷功能整合设计
  - 快捷菜单设计
  - 悬浮球交互逻辑设计
  - 对话记录查看功能（轻量化）
    - 分页显示最近对话
    - 时间格式化显示
    - 清空/导出功能
  - 问题检测与修复
- 基础控制面板实现 #7 (Backlog, Size: L)
  - 全部功能整合设计
  - 界面设计
  - 配置界面
  - 参数调整功能
- **快捷键支持**
  - 可自定义快捷键
- **右键菜单**
  - 播放动画/表情
  - 切换模型
  - 打开控制面板
  - 截图
  - 设置
- **窗口控制功能**
  - 缩放人物大小（滚轮或快捷键）
  - 窗口置顶开关
  - 窗口半透明度调节（可选）
  - 截图功能
- 更新API文档和相关说明文档

### P0 - 对话文字渲染系统
- **对话文本节点（DialogueLabel）**
  - 作为 CharacterWindow 的子节点（非独立窗口）
  - 使用 CanvasLayer 实现灵活渲染
  - 无背景文本框（纯文字渲染）
  - 自动跟随人物窗口
  - 多位置预设：上方（头顶）、左侧、右侧、下方、中间（人物身上）
  - 可配置位置偏移量和锚点
  - 避免独立窗口的性能和鼠标穿透问题
- **打字机效果（Typewriter Effect）**
  - 逐字显示动画
  - 可调速度（字符/秒）
  - 标点符号延迟优化（句号停顿更长）
  - 发射逐字符显示事件（用于口型同步）
- **文本渲染**
  - 富文本支持（颜色、粗体、斜体）
  - 自动换行（智能断词）
  - 超长文本处理策略：
    - 滚动显示（保留历史行）
    - 最大行数限制（超出淡出旧内容）
    - 分页显示（可选）
  - 文字阴影/描边（提高可读性）
  - 字体大小/样式可配置
  - 使用超长预设文本测试边界情况
- **文本来源处理**
  - LLM 流式输出接入（逐 token 显示）
  - 本地预设文本加载
  - 对话栏用户输入回显
  - 选项选择结果显示
- **交互功能**
  - 点击对话窗口跳过打字机效果
  - 自动隐藏（N 秒后淡出然后清除）
  - 手动显示/隐藏
  - 对话历史缓存，序列化记忆缓存
  - 对话历史回看/重新播放（可选）
- **通信机制**
  - 通过信号接收对话内容
  - ServiceLocator 获取当前对话状态
  - 与 CharacterWindow 位置同步

> 详细设计文档: `docs/design/dialogue-rendering-system.md` ✅

### P0 - 深度触摸交互系统 
- **TouchInteractionService（触摸交互服务）**
  - 右键按住触发深度交互
  - 光标切换为手型
  - 协调各子系统
- **TouchZoneManager（触摸区域管理器）**
  - 定义多个触摸区域（头部、身体、四肢等）
  - 区域优先级管理
  - 与 HitAreaManager 集成
- **TouchGestureAnalyzer（手势分析器）**
  - 识别手势类型（点击、长按、滑动、拖拽）
  - 计算速度、加速度、力度
  - 分析触摸轨迹
- **TouchFeedbackController（反馈控制器）**
  - 实时 Live2D 参数调整（拖拽跟随）
  - 表情/动画切换
  - 音效和文本反馈
  - 根据力度差异化反馈
- **BehaviorMemorySystem（行为记忆系统）** - Phase 2
  - 记录用户触摸习惯
  - 分析偏好模式（最喜欢的区域、手势、力度）
  - 生成个性化响应
  - 行为数据持久化
- **与好感度系统联动** - Phase 2
  - 好感度门槛解锁机制
  - 不同亲密度下的差异化反馈
  - 拒绝反馈设计

> 详细设计文档: `docs/design/deep-interaction-system.md` 

> 参考研究: `docs/research/好感驱动的互动演化机制.txt`、`角色触摸互动创新机制研究.txt`

### P0 - 口型同步系统（Lip Sync）
- **ParameterController（Live2D 参数控制器）**
  - 统一管理所有 Live2D 参数
  - 参数缓存机制（高性能）
  - 参数分组管理（mouth/eyes/eyebrows/head/body）
  - 支持参数混合/插值
  - 批量参数设置接口
- **MouthShapeMapper（口型映射器）**
  - **中精度字符映射**（~70% 准确率）
  - 支持多语言：中文、英文、日文、韩文
  - AEIOU 标准口型映射
  - 基于字符特征的规则映射（避免复杂音素分析）
  - 标点符号 → 闭嘴处理
- **LipSyncService（口型同步服务）**
  - 监听打字机效果逐字符事件
  - 实时更新 Live2D 口型参数
  - 平滑口型过渡动画
  - 自动闭嘴检测（文本停顿后）
  - 可配置强度和平滑度
- **集成与配置**
  - 与 DialogueWindow 无缝集成
  - LipSyncConfig 配置系统
  - 支持启用/禁用
  - 性能优化（< 0.1ms 延迟）
- **未来扩展（Phase 2+）**
  - 音频驱动口型同步（TTS 集成后）
  - 拼音库支持（提升中文准确率到 85%+）
  - Rhubarb Lip Sync 数据导入

> 详细设计文档: `docs/design/lip-sync-system.md` ✅

### P0 - 人物配置与架构解耦
- **人物配置系统（CharacterConfig）**
  - 统一配置文件格式（JSON/TOML）
  - 配置内容：
    - 模型路径和参数
    - 角色基础信息（姓名、性格、背景）
    - 提示词模板（System Prompt）
    - 预设对话素材库
    - 表情/动作映射配置
    - 音色配置（TTS 参数）
  - 配置加载与验证
  - 配置热重载机制
- **渲染窗口与中控解耦（架构级）**
  - 问题：单场景直接切换人物模型有 bug
  - 解决方案（Godot 内部解耦）：
    - **多场景管理**：
      - CharacterWindow Scene（渲染层）
      - ControlPanel Scene（中控层）
      - 使用 Godot 的场景切换/重载机制
    - **通信方式**（零性能开销）：
      - Godot 信号系统（Signal）- 主要方式
      - ServiceLocator 服务访问
      - 事件总线（EventBus）- 全局事件
      - 直接节点引用（需要时）
    - **NOT 使用真正的 IPC/多进程**（避免性能开销）
  - 架构设计：
    - ControlPanel 持有全局状态和配置
    - CharacterWindow 仅负责渲染和表现
    - 悬浮球（FloatingBall）作为 CharacterWindow 的子节点
    - 通过信号通知状态变化
  - 生命周期管理：
    - 切换模型：`queue_free()` 旧场景 → 加载新场景
    - 重启渲染：重新实例化 CharacterWindow Scene
    - 中控持久化：使用 AutoLoad 单例保持状态
    - 配置热重载：信号通知 → CharacterWindow 重新加载
- **人物管理器（CharacterManager）**
  - 扫描可用人物配置
  - 当前活跃人物管理
  - 人物切换接口
  - 配置校验与错误处理

> 详细设计文档: `docs/design/character-config-system.md`（待创建）

### P0 - 性能监控与错误处理
- **错误恢复机制（ErrorRecoveryService）** 
  - 模型加载失败处理 
  - 动画播放失败处理（优雅重置回到 Idle）
  - 参数设置失败处理
  - 崩溃日志记录
  - 错误提示对话框
  - 自动重试机制
- **性能监控系统（Debug 模式）**
  - FPS 显示（Debug 模式，集成到控制面板开关）
  - 各服务耗时统计
  - 内存占用监控
  - 性能瓶颈检测
- **资源管理优化**
  - 内存泄漏检测
  - 资源释放确认
  - 懒加载优化
  - 资源池管理（可选）

> 详细设计文档: `docs/design/performance-and-stability.md`（待创建）

### P1 - 表情动作系统
- 完整的表情和动作控制 #6 (Backlog, Size: L)
  - 读取模型配置信息，并建立动态配置文件
  - Motion Dictionary (动作字典)
  - 制作动态参数控制器
  - 制作预设控制模板
  - Emotion Mapping (情绪映射)
  - Viseme Mapping (口型映射)
  - 简易状态机设计
  - 状态机应用，环境测试
  - 完整制作相关配置信息，为每个模型制作相关的角色卡，渲染器读取配置信息

### 里程碑
- M1.5.1: HitArea 检测准确可靠
- M1.5.2: 基础交互系统可用（悬浮球+控制面板）
- M1.5.3: 对话文字渲染系统可用（打字机效果+跟随人物）
- M1.5.4: 人物配置系统可用，支持配置加载
- M1.5.5: 渲染窗口与中控解耦，支持独立重启
- M1.5.6: 人物管理器可用，支持多人物配置
- M1.5.7: 表情动作系统完整
- M1.5.8: 渲染层 API 稳定，无需频繁重构

---

## Phase 2: Context 模块基础

**状态**: 规划中  
**目标**: 搭建 Context 核心框架，实现基础的记忆-决策循环

### 渲染架构抽象化（新增）
- **渲染器抽象层设计**
  - 创建 `ICharacterRenderer` 接口
  - 定义统一的渲染器 API（加载模型、播放动画、设置参数）
  - 支持多种渲染后端
  - 渲染器工厂模式
- **Live2D 渲染器封装**
  - 将现有 Live2D 服务适配到抽象接口
  - 保持现有功能完全不变
  - 作为主要渲染方案
- **2D Sprite 渲染器（降级方案）**
  - 实现简单的 2D 图片序列渲染
  - 作为免费替代方案
  - 无 Live2D 许可证限制
- **DLC 包格式设计**
  - 定义 `.dlc` 文件格式（包含角色数据、模型、配置）
  - 支持多种渲染类型标记
  - 包含许可证信息字段
  - 加密/签名机制（可选）
- **渲染器插件管理**
  - 检测已安装渲染器
  - 自动选择合适渲染器
  - 降级处理机制

> 设计文档：`docs/design/renderer-architecture.md`（待创建）

### 人物配置完善
- **多人物管理系统**
  - 人物列表管理（添加/删除/导入/导出）
  - 人物快速切换（重启渲染窗口）
  - 当前激活人物状态管理
  - 配置文件校验与修复
- **角色卡系统（Character Card）**
  - 完整的角色设定存储
  - 提示词模板管理（支持变量替换）
  - 预设对话库（分类：问候/陪伴/反馈/闲聊）
  - 角色特定的决策参数
  - 导入/导出标准格式（兼容 CharacterAI/Tavern）
- **人物绑定数据**
  - 每个人物独立的记忆数据
  - 人物切换时保存/加载状态
  - 好感度、心情等数值模型绑定
- **控制面板人物管理 UI**
  - 人物选择器
  - 配置编辑器
  - 实时预览
  - 一键重载

> 详细设计文档: `docs/design/character-config-system.md`（待创建）

### 模块化系统设计
- **模块管理器**
  - ModuleManager 核心
  - 模块发现与注册
  - 依赖检查与自动加载
  - 配置持久化
- **MVVM 框架基础**
  - 使用Godot MVVM插件支持（待考虑）
  - Model/ViewModel/View 分离
  - 数据绑定机制
  - UI 自动更新
- **模块管理 UI**
  - 控制面板集成
  - 支持模块列表更新、启用与关闭
  - 配置界面

> 详细设计文档: `docs/design/module-system.md`（待创建）

### 外部服务接口
- **通用模型接口**
  - 统一 API 设计 (ModelRequest/Response)
  - 抽象 Provider 接口
  - 模型类型枚举（LLM/VLM/TTS）
- **供应商适配器**
  - OpenAI / Claude / DeepSeek / Ollama
  - 可扩展的 Adapter 模式
- **Provider Manager**
  - 供应商注册与管理
  - 配置文件加载
  - 控制面板 UI
- **HTTP 调用封装**
  - LLM/VLM/TTS 统一接口
  - 超时与重试机制
- **数据库连接**
  - 长期记忆存储（外部服务）
  - SQLite 短期记忆（会话级）

> 详细设计文档: `docs/design/external-services.md`（待创建）

### 记忆模块 (Memory Module)
- 短期记忆管理
  - 当前会话数据存储
  - 内存缓存机制
- 序列记忆基础
  - 交互记录存储
  - 对话记录存储
  - 感知序列记录
- 符号化记忆（推理记忆）
  - 基础推理结构
  - 记忆关联机制

### 感知模块 (Perception Module)
- **基础感知器（快速原型）**
  - 键鼠活动监测
  - 前台窗口检测（应用名称、标题）
  - 时间信息采集
  - 系统音频状态
- **上下文构建器**
  - 结构化数据输出
  - 传递到决策模块
  - 数据隐私过滤
- **感知数据模型**
  - 统一数据格式
  - 采样频率控制

> 详细设计文档: `docs/design/perception-system.md`（待创建）

### 决策模块 (Decision Module)
- **快速决策引擎**
  - 规则引擎基础（基于感知数据）
  - 活动识别（工作/娱乐/休息）
  - 专注度评估
  - 小模型集成（可选）
  - 快速响应 <300ms
- **慢速决策接口**
  - LLM 调用接口设计
  - 异步处理机制
  - 流式输出支持
- **行为生成器（原型）**
  - 基于模板的行为生成
  - 简单的 Action 构建
- **决策理由记录**

> 详细设计文档: `docs/design/decision-system.md`（待创建）

### 仲裁核心 (Arbitration - 原型)
- **优先级队列（原型）**
  - 用户输入 > 系统警告 > 主动对话 > 定时提醒
  - 简单的请求排队机制
- **基础冲突处理**
  - 高优先级中断低优先级
  - 同级请求队列
- **状态机基础**
  - 空闲/执行中/等待 状态切换

> 快速原型阶段只实现基础功能，Phase 3 完善可抢占调度

### 数值模型 (Numerical Models)
- 关系建模
  - 好感度系统 (0-100)
  - 等级系统
- 心情建模
  - 数学值表示 (-100~+100)
  - 程度值映射
  - 自然衰减机制
- 性格建模
  - 大五人格或 MBTI
  - 4~5 个数值维度
  - 影响决策权重

### 里程碑
- M2.0: 渲染器抽象层完成，支持多渲染器
- M2.0.1: Live2D 渲染器适配到抽象接口
- M2.0.2: Sprite 渲染器实现（降级方案）
- M2.0.3: DLC 包格式定义并可加载
- M2.1: 多人物管理系统可用
- M2.2: 角色卡系统可导入/导出
- M2.3: 人物绑定数据正常切换
- M2.4: 模块管理系统可用
- M2.5: MVVM 框架基础完成
- M2.6: Context 框架搭建完成
- M2.7: 感知模块能采集基础数据
- M2.8: 记忆模块基础可用
- M2.9: 决策模块能做简单判断（基于规则）
- M2.10: 仲裁核心原型可用（优先级队列）
- M2.11: 数值模型可读写
- M2.12: 外部服务调用通畅
- M2.13: 完整数据流：感知→记忆→决策→仲裁→输出

---

## Phase 3: 行为调度与完整循环

**状态**: 规划中  
**目标**: 实现完整的"感知→决策→调度→执行→表现"闭环

### 行为调度器 (Dispatcher - 核心)
- **二层任务系统（模拟人生式）**
  - 大任务（Action）：行为序列
  - 小任务（Task）：原子操作
  - 任务队列管理
- **调度核心**
  - 大任务队列（FIFO + 优先级）
  - 小任务队列（当前 Action 内）
  - 当前执行任务追踪
- **执行规则**
  - 小任务原子性（不可打断）
  - 大任务可打断（等小任务完成）
  - 高优先级任务插队
- **任务执行器（Executors）**
  - 对话执行器（LLM + TTS + 口型）
  - 动画执行器（Live2D 动作）
  - 观察执行器（感知采样）
  - 等待执行器（延时任务）
  - 系统交互执行器
- **反馈机制**
  - 任务执行状态回报
  - 失败重试策略
  - 执行日志记录

> 详细设计文档: `docs/design/dispatcher-system.md`（待创建）

### 仲裁核心完善 (Arbitration)
- **可抢占调度**
  - 打断当前 Action（等小任务完成）
  - 取消剩余小任务
  - 执行新的高优先级 Action
- **冲突解决策略**
  - 超时机制（防止卡死）
  - 可打断 vs 不可打断标记
  - 紧急事件处理
- **状态机完善**
  - 空闲/执行中/等待打断/暂停 状态
  - 状态切换日志
- **调度策略**
  - 用户输入立即响应
  - 定时任务延迟执行
  - 背景任务低优先级

> 详细设计文档: `docs/design/arbitration-system.md`（待创建）

### 动作序列库 (Action Library)
- **预定义动作模板**
  - 日常问候、工作陪伴、游戏陪玩
  - 定时提醒、情绪反馈
  - 用户互动响应
- **动作参数化**
  - 动作参数定义（持续时间、优先级、可打断性）
  - 动作变体（同一行为的不同表达）
- **具体 Task 实现**
  - 对话 Task（LLM 生成 + TTS + 口型）
  - 动画 Task（Live2D 动作播放）
  - 观察 Task（环境采样）
  - 等待 Task（延时、条件等待）
  - 移动 Task（窗口位置控制）

### 感知系统完善 (Perception)
- **深度感知器（可选）**
  - 屏幕截图 + OCR
  - 视觉理解（VLM）
  - 剪贴板监测（需授权）
  - 输入内容捕获（需授权）
- **感知策略优化**
  - 按需采样（避免持续监控）
  - 数据过滤与隐私保护
  - 采样频率自适应
- **上下文智能构建**
  - 环境变化检测
  - 活动模式识别
  - 专注度评估
  - 传递到决策模块

### 记忆系统完善
- 序列记忆扩展
  - 交互序列完整记录
  - 对话历史管理
  - 感知序列存储
- 信息固化机制
  - 短期记忆筛选
  - 转化为长期记忆
  - 整理到外部数据库
- 符号化记忆增强
  - 推理记忆生成
  - 关联网络构建

### 决策系统完善
- 快速决策增强
  - 规则引擎扩展
  - 模式识别
  - 活动识别（工作/娱乐/休息）
- 慢速决策优化
  - LLM 上下文管理
  - 角色人格应用
  - 情绪状态影响
- 决策与记忆联动
  - 基于记忆的决策
  - 决策结果反馈到记忆

### TTS 与口型同步
- TTS 调用优化
  - 本地/云端 TTS 集成
  - Text Blip / Voice Blip
  - 断句优化
- Viseme 生成
  - 音素数据生成
  - 时间对齐
- 口型同步播放
  - Viseme Mapping 应用
  - 与 Live2D 渲染联动

### 里程碑
- M3.1: Dispatcher 调度器核心可用
- M3.2: 二层任务系统运作（Action + Task）
- M3.3: 仲裁核心可抢占调度
- M3.4: 动作序列库可用（预定义模板）
- M3.5: 任务执行器完整（对话/动画/观察）
- M3.6: 感知系统完善（深度感知可选）
- M3.7: 记忆固化机制运作
- M3.8: 决策能基于记忆和数值模型
- M3.9: TTS 播放并同步口型
- M3.10: 完整闭环：感知→记忆→决策→仲裁→调度→执行→表现

---

## Phase 4: 高级功能与优化

**状态**: 规划中  
**目标**: 增强体验、优化性能、完善生态

### 行为学习系统
- 时间偏好学习
  - 周/日统计分析
  - 互动模式识别
- 活动偏好学习
  - 工作/游戏/休息场景分析
  - 互动方式偏好（文字/语音）
- 学习机制
  - 数据积累（2-4周）
  - 置信度评估
  - 决策权重调整
- 可视化管理
  - 行为模式图表
  - 重置学习数据

### 日常互动功能
- 日常仪式
  - 时间仪式：早安/晚安、午休提醒
  - 活动仪式：工作开始/结束
  - 成就仪式：连续打卡、好感度突破
- 共同活动
  - 观看内容（视频播放检测）
  - 游戏陪玩（游戏识别、画面理解）
  - 听音乐、陪伴工作学习
  - 活动记录与回忆
- 惊喜系统
  - 随机事件
  - 隐藏台词
  - 收藏系统

### 渐进记忆与总结
- 记忆总结
  - 每日/周/月自动总结
  - 记忆重要性评分
- 记忆优化
  - 记忆压缩与遗忘
  - 相似记忆合并
- 用户管理
  - 记忆历史可编辑
  - 删除/标记功能

### 性能优化
- 资源占用优化
  - 目标：空闲 CPU <5%, GPU <10%, 内存 <500MB
- 缓存策略
  - LLM 回复缓存
  - TTS 音频缓存
  - 感知数据缓存
- 离线降级
  - 完全在线 → 混合模式 → 完全离线
  - 平滑切换，用户无感

### 高级表现功能
- VTuber 表现
  - 精确口型同步优化
  - 音乐节拍同步
  - 微表情系统
  - 眼神交互增强
- 多渲染器扩展
  - **VRM (3D) 渲染器**（优先）
    - 开源免费，VTuber 标准
    - 支持 3D 虚拟形象
    - 实现 ICharacterRenderer 接口
  - **Spine 渲染器**（可选）
    - 2D 骨骼动画支持
    - 需 Spine Runtime 许可
  - **Godot 3D 渲染器**（可选）
    - 自定义 3D 场景
    - 完全自由控制
  - 渲染器插件系统完善
- 教学系统
  - 事实教学（用户信息、偏好）
  - 表达教学（梗、网络用语）
  - 技能教学（任务、流程）

### 工具与生态
- 控制面板完善
  - 模块开关、参数配置
  - 记忆管理、日志查看
  - 行为分析、决策解释
- 角色管理器
  - 模型导入、角色切换
  - 配置导入/导出
- 开发工具
  - 角色配置编辑器
  - 行为编辑器
- 社区功能
  - 在线更新、插件市场
  - 资源分享、社区支持

### 里程碑
- M4.1: 行为学习系统运作
- M4.2: 日常互动完整
- M4.3: 性能达标，稳定运行
- M4.4: 高级功能可用
- M4.5: Beta 版本发布
- M4.6: v1.0 正式发布

---

## 功能优先级矩阵

| 功能 | 优先级 | 阶段 | 状态 |
|------|--------|------|------|
| Live2D 基础渲染 | P0 | Phase 1 | 已完成 |
| 窗口系统 | P0 | Phase 1 | 已完成 |
| HitArea 检测 | P0 | Phase 1.5 | 进行中 |
| 表情动作系统 | P0 | Phase 1.5 | 进行中 |
| 交互系统（悬浮球/控制面板） | P0 | Phase 1.5 | 进行中 |
| 对话文字渲染系统 | P0 | Phase 1.5 | 规划中 |
| 人物配置系统 | P0 | Phase 1.5 | 规划中 |
| 渲染窗口与中控解耦 | P0 | Phase 1.5 | 规划中 |
| 人物管理器（基础） | P0 | Phase 1.5 | 规划中 |
| 渲染器抽象层 | P1 | Phase 2 | 规划中 |
| Live2D 渲染器适配 | P1 | Phase 2 | 规划中 |
| Sprite 渲染器（降级方案） | P1 | Phase 2 | 规划中 |
| DLC 包格式设计 | P1 | Phase 2 | 规划中 |
| 多人物管理系统 | P0 | Phase 2 | 规划中 |
| 角色卡系统 | P0 | Phase 2 | 规划中 |
| 人物绑定数据 | P1 | Phase 2 | 规划中 |
| 模块管理系统 | P1 | Phase 2 | 规划中 |
| MVVM 框架基础 | P1 | Phase 2 | 规划中 |
| Context 框架 | P0 | Phase 2 | 规划中 |
| 感知模块（基础感知器） | P0 | Phase 2 | 规划中 |
| 记忆模块（短期/序列/符号化） | P0 | Phase 2 | 规划中 |
| 决策模块（快速/慢速） | P0 | Phase 2 | 规划中 |
| 仲裁核心（原型） | P0 | Phase 2 | 规划中 |
| 数值模型（好感度/心情/性格） | P0 | Phase 2 | 规划中 |
| 外部服务接口（LLM/TTS/DB） | P0 | Phase 2 | 规划中 |
| 行为调度器（Dispatcher） | P0 | Phase 3 | 规划中 |
| 仲裁核心完善（可抢占） | P0 | Phase 3 | 规划中 |
| 动作序列库 | P0 | Phase 3 | 规划中 |
| 任务执行器 | P0 | Phase 3 | 规划中 |
| 感知系统完善（深度感知） | P1 | Phase 3 | 规划中 |
| 记忆固化机制 | P1 | Phase 3 | 规划中 |
| 决策与记忆联动 | P1 | Phase 3 | 规划中 |
| TTS + 口型同步 | P0 | Phase 3 | 规划中 |
| 行为学习系统 | P1 | Phase 4 | 规划中 |
| 日常互动（仪式/活动/惊喜） | P2 | Phase 4 | 规划中 |
| 渐进记忆与总结 | P2 | Phase 4 | 规划中 |
| 性能优化 | P1 | Phase 4 | 规划中 |
| VTuber 表现 | P2 | Phase 4 | 规划中 |
| VRM 渲染器（3D） | P2 | Phase 4 | 规划中 |
| Spine 渲染器 | P3 | Phase 4+ | 规划中 |
| Godot 3D 渲染器 | P3 | Phase 4+ | 规划中 |
| 教学系统 | P2 | Phase 4 | 规划中 |
| 完整工具链 | P2 | Phase 4 | 规划中 |
| 插件生态 | P3 | Phase 4+ | 规划中 |

**优先级说明**:
- P0: 核心功能，必须实现
- P1: 重要功能，影响体验
- P2: 增强功能，提升价值
- P3: 扩展功能，锦上添花

---

## 版本规划

**版本命名规范**: `v{Major}.{Minor}.{Patch}-{stage}-{date}-{stability}`
- Major: 重大架构变更（不向下兼容）
- Minor: 新功能模块添加
- Patch: Bug 修复和小改进
- stage: alpha / beta / rc
- stability: stable / unstable
- date：当前包含多个测试版本，需要明确区分的情况
- 正式版本只会包含`v{Major}.{Minor}.{Patch}`

| 版本 | 目标日期 | 主要内容 | 对应阶段 |
|------|---------|---------|---------|
| v0.0.9-alpha | 当前 | 渲染层完善进行中 | Phase 1.5 |
| v0.0.10-alpha | TBD | HitArea + 事件系统稳定 | Phase 1.5 |
| v0.0.11-alpha | TBD | 悬浮球 + 控制面板基础 + 对话文字渲染 | Phase 1.5 |
| v0.0.12-alpha | TBD | 人物配置系统 + 渲染窗口解耦 | Phase 1.5 |
| v0.1.0-alpha | TBD | 表情动作系统完整 + 人物管理器 + 渲染层 API 稳定 | Phase 1.5 完成 |
| v0.2.0-alpha | TBD | 多人物管理 + 角色卡系统 + Context 框架 | Phase 2 开始 |
| v0.2.5-alpha | TBD | 决策模块 + 仲裁核心原型 + 数值模型 | Phase 2 中期 |
| v0.3.0-alpha | TBD | 外部服务接口完整，Phase 2 完成 | Phase 2 完成 |
| v0.4.0-alpha | TBD | Dispatcher 调度器 + 动作序列库 | Phase 3 开始 |
| v0.4.5-alpha | TBD | 仲裁完善 + 任务执行器 + 感知完善 | Phase 3 中期 |
| v0.5.0-alpha | TBD | TTS + 口型同步 + 完整闭环运作 | Phase 3 完成 |
| v0.6.0-beta | TBD | 行为学习系统 + 日常互动 | Phase 4 开始 |
| v0.7.0-beta | TBD | 性能优化 + 工具完善 | Phase 4 中期 |
| v0.8.0-rc | TBD | Beta 测试版本，功能完整 | Phase 4 后期 |
| v1.0.0 | TBD | 正式发布 | Phase 4 完成 |

**说明**:
- Phase 1.5 内部使用 v0.0.x 迭代（小功能和修复）
- Phase 2-4 每个大功能模块完成递增 Minor 版本 (0.x.0)
- 中期里程碑使用 .5 版本 (0.x.5)
- 进入 Beta 阶段后版本号为 v0.6.0+
- 只有架构重大变更才会改 Major 版本号

---

## 技术债务追踪

### 当前技术债
- renderer/ 目录需重命名为 engine/（正在重构）
- 部分 Legacy 代码需迁移
- 服务间通信需统一事件系统
- 配置文件格式需规范化

### 优先级
1. 高: 影响架构或性能
2. 中: 代码质量和可维护性
3. 低: 命名、注释等规范

---

## 未来展望

### 长期目标
- 多平台支持（macOS, Linux）
- 移动端适配（Android, iOS）
- VRM 模型支持
- 本地小模型运行
- 插件市场生态
- 支持开发工具快捷配置

### 实验性功能
- VTuber 直播模式
- 游戏实况陪玩
- 桌面自动化助手（ControlARM）
- 多角色联动互动
- AR/VR 模式

---

## 贡献方向

### 当前欢迎
- Bug 报告和测试
- 文档改进
- Live2D 模型适配
- LLM/TTS 提供商支持

### Phase 2 可参与
- 感知模块（窗口/音频监测）
- 配置 UI 设计
- 动画状态机优化

### Phase 3+ 规划讨论
- 记忆系统设计
- 行为决策策略
- 用户体验创意

---

## 📚 相关文档索引

### 核心文档
- [Phase 1.5 完成清单](PHASE_1.5_COMPLETION_CHECKLIST.md) - 当前阶段详细任务和标准
- [渲染层完整性检查](design/rendering-layer-checklist.md) - 功能遗漏检查和优先级
- [技术设计文档目录](design/README.md) - 所有详细设计文档索引

### 设计文档（Phase 1.5）
- [对话文字渲染系统](design/dialogue-rendering-system.md) - CanvasLayer 方案完整设计
- [口型同步系统](design/lip-sync-system.md) - 多语言中精度映射方案
- [深度触摸交互系统](design/deep-interaction-system.md) - 手势识别和多层次反馈

### 研究文档
- [好感驱动的互动演化机制](research/好感驱动的互动演化机制.txt)
- [角色触摸互动创新机制研究](research/角色触摸互动创新机制研究.txt)

### 规划与愿景
- [项目愿景](vision/vision.md) - 设计理念和目标
- [架构设计](architecture/architecture.md) - Context-centric 架构详解
- [功能特性](features/README.md) - 各阶段功能规划

### 技术设计（待创建）
- `docs/design/renderer-architecture.md` - 多渲染器架构设计
- `docs/design/dlc-format-spec.md` - DLC 包格式规范
- `docs/design/module-system.md` - 模块管理系统详细设计
- `docs/design/external-services.md` - 外部服务接口详细设计
- `docs/design/memory-system.md` - 记忆系统详细设计
- `docs/design/decision-system.md` - 决策系统详细设计

### 开发指南
- [贡献指南](CONTRIBUTING.md) - 如何参与开发
- [代码规范](CODING_STANDARDS.md) - 代码风格指南
- [环境配置](SETUP_GUIDE.md) - 开发环境搭建

---

## 📊 当前状态总结

**Phase 1.5 设计完整度**: **85%** ✅  
**核心原则**: 打好基础，预留接口，为后续迭代铺路

### 已完成
- ✅ 渲染层核心功能（85% 完成）
- ✅ 对话渲染系统设计（100%）
- ✅ 口型同步系统设计（100%）
- ✅ 深度触摸交互设计（100%）
- ✅ 所有 Phase 2/3/4 扩展接口预留
- ✅ 许可证策略明确（游戏/应用定位）

### 许可证合规状态 
- **项目定位**: 桌面陪伴游戏/应用（非创作工具）
- **Live2D 许可**: 归类为普通游戏/应用（非可扩展性应用）
- **架构设计**: DLC + MOD 模式，用户不能导入任意模型
- **合规策略**: 框架开源（Apache 2.0），DLC 制作者负责内容许可
- **风险等级**: 低风险（个人非商业项目免费使用）

### 接下来
1. **实现 Phase 1.5 核心功能**（7 周预估）
2. **完善配置和管理系统**（人物配置、错误恢复）
3. **充分测试和文档完善**
4. **Phase 2 渲染器抽象化**（为多渲染器支持铺路）
5. **Phase 2 Context 模块开发**（记忆-决策循环）

**路线图更新频率**: 每个 Phase 结束后更新，或有重大设计变更时更新。

---

**注**: 本路线图为指导性文档，实际开发可能根据情况调整。欢迎在 [Issues](https://github.com/MarionetLab/Marionet/issues) 提出建议。

