name: CI - ä»£ç è´¨é‡æ£€æŸ¥

on:
  push:
    branches: [ dev, main ]
  pull_request:
    branches: [ dev, main ]

env:
  GODOT_VERSION: "4.5-stable"
  DOTNET_VERSION: "8.0.x"

jobs:
  # 1. GDScript è¯­æ³•å’Œé£æ ¼æ£€æŸ¥
  gdscript-check:
    name: GDScript æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£… gdlint
        run: |
          pip install gdtoolkit==4.*

      - name: è¿è¡Œ GDScript è¯­æ³•æ£€æŸ¥
        run: |
          cd engine
          gdlint --version
          gdlint renderer/scripts/ renderer/services/ renderer/ui/ core/ || echo "è­¦å‘Š: å‘ç°ä»£ç é£æ ¼é—®é¢˜"

  # 2. C# ç¼–è¯‘æ£€æŸ¥
  csharp-build:
    name: C# ç¼–è¯‘æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ä¸‹è½½ Godot
        run: |
          wget -q https://github.com/godotengine/godot/releases/download/${{ env.GODOT_VERSION }}/Godot_v${{ env.GODOT_VERSION }}_mono_linux_x86_64.zip
          unzip -q Godot_v${{ env.GODOT_VERSION }}_mono_linux_x86_64.zip
          chmod +x Godot_v${{ env.GODOT_VERSION }}_mono_linux_x86_64/Godot_v${{ env.GODOT_VERSION }}_mono_linux.x86_64

      - name: C# é¡¹ç›®ç¼–è¯‘æ£€æŸ¥
        run: |
          cd engine
          dotnet build MarionetEngine.csproj --configuration Release
        continue-on-error: false

  # 3. Godot é¡¹ç›®åŸºç¡€æ£€æŸ¥
  godot-project-check:
    name: Godot é¡¹ç›®ç»“æ„æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æŸ¥å¿…éœ€çš„é¡¹ç›®æ–‡ä»¶
        run: |
          cd engine

          echo "æ£€æŸ¥ Godot é¡¹ç›®æ–‡ä»¶..."

          # æ£€æŸ¥å¿…éœ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          required_files=(
            "project.godot"
            "core/Main.gd"
            "core/ServiceLocator.gd"
            "core/Constants.gd"
          )

          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done

          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "âŒ ç¼ºå°‘å¿…éœ€æ–‡ä»¶:"
            printf '%s\n' "${missing_files[@]}"
            exit 1
          fi

          echo "âœ“ æ‰€æœ‰å¿…éœ€é¡¹ç›®æ–‡ä»¶éƒ½å­˜åœ¨"

          # æ£€æŸ¥ project.godot æ ¼å¼
          if ! grep -q "config_version=5" project.godot; then
            echo "âŒ project.godot æ ¼å¼å¯èƒ½æœ‰è¯¯"
            exit 1
          fi

          echo "âœ“ project.godot æ ¼å¼æ­£ç¡®"

          # æ£€æŸ¥åœºæ™¯æ–‡ä»¶æ ¼å¼ï¼ˆç®€å•éªŒè¯ï¼‰
          echo "æ£€æŸ¥åœºæ™¯æ–‡ä»¶..."
          for scene in scenes/*.tscn; do
            if [ -f "$scene" ]; then
              if ! head -n 1 "$scene" | grep -q "gd_scene"; then
                echo "âš ï¸  $scene å¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„åœºæ™¯æ–‡ä»¶"
              fi
            fi
          done

          echo "âœ“ Godot é¡¹ç›®ç»“æ„æ£€æŸ¥å®Œæˆ"
          echo ""
          echo "æ³¨æ„: CI ç¯å¢ƒä¸åŒ…å« GDCubism æ’ä»¶ï¼Œè¿™æ˜¯æ­£å¸¸çš„ã€‚"
          echo "æ’ä»¶ç›¸å…³çš„é”™è¯¯åœ¨ CI ä¸­ä¼šè¢«å¿½ç•¥ã€‚"

  # 4. æ–‡ä»¶ç»“æ„å’Œå‘½åè§„èŒƒæ£€æŸ¥
  file-structure-check:
    name: æ–‡ä»¶ç»“æ„æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æŸ¥æ–‡ä»¶å‘½åè§„èŒƒ
        run: |
          cd engine
          # æ£€æŸ¥ GDScript æ–‡ä»¶æ˜¯å¦ä½¿ç”¨ PascalCase
          echo "æ£€æŸ¥ GDScript æ–‡ä»¶å‘½å..."
          find renderer/services renderer/scripts core -name "*.gd" | while read file; do
            filename=$(basename "$file" .gd)
            if ! [[ "$filename" =~ ^[A-Z][a-zA-Z0-9]*$ ]]; then
              echo "è­¦å‘Š: $file ä¸ç¬¦åˆ PascalCase å‘½åè§„èŒƒ"
            fi
          done

          # æ£€æŸ¥ C# æ–‡ä»¶æ˜¯å¦ä½¿ç”¨ PascalCase
          echo "æ£€æŸ¥ C# æ–‡ä»¶å‘½å..."
          find renderer/services -name "*.cs" | while read file; do
            filename=$(basename "$file" .cs)
            if ! [[ "$filename" =~ ^[A-Z][a-zA-Z0-9]*$ ]]; then
              echo "è­¦å‘Š: $file ä¸ç¬¦åˆ PascalCase å‘½åè§„èŒƒ"
            fi
          done

      - name: æ£€æŸ¥ç¦æ­¢æäº¤çš„æ–‡ä»¶
        run: |
          # æ£€æŸ¥æ˜¯å¦æ„å¤–æäº¤äº† bin æ–‡ä»¶
          if find engine/addons/gd_cubism/bin -name "*.dll" -o -name "*.so" -o -name "*.dylib" 2>/dev/null | grep -q .; then
            echo "é”™è¯¯: æ£€æµ‹åˆ°ä¸åº”æäº¤çš„æ’ä»¶äºŒè¿›åˆ¶æ–‡ä»¶"
            echo "è¯·å°†ä»¥ä¸‹æ–‡ä»¶æ·»åŠ åˆ° .gitignore:"
            find engine/addons/gd_cubism/bin -name "*.dll" -o -name "*.so" -o -name "*.dylib"
            exit 1
          fi

  # 5. æ–‡æ¡£åŒæ­¥æ£€æŸ¥
  documentation-check:
    name: æ–‡æ¡£å®Œæ•´æ€§æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æŸ¥å¿…éœ€æ–‡æ¡£
        run: |
          required_docs=(
            "README.md"
            "docs/CONTRIBUTING.md"
            "docs/CODING_STANDARDS.md"
            "docs/architecture/architecture.md"
          )

          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "é”™è¯¯: ç¼ºå°‘å¿…éœ€æ–‡æ¡£ $doc"
              exit 1
            fi
          done

          echo "æ‰€æœ‰å¿…éœ€æ–‡æ¡£éƒ½å­˜åœ¨ âœ“"

      - name: æ£€æŸ¥ Markdown æ ¼å¼
        uses: DavidAnson/markdownlint-cli2-action@v18
        with:
          globs: |
            docs/**/*.md
            *.md
        continue-on-error: true

  # 6. ä»£ç å®‰å…¨æ‰«æ
  security-check:
    name: å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
        run: |
          echo "æ£€æŸ¥æ˜¯å¦æ³„éœ²æ•æ„Ÿä¿¡æ¯..."

          # æ£€æŸ¥ç¡¬ç¼–ç çš„å¯†é’¥ã€å¯†ç ç­‰
          if grep -r -i -E "(password|secret|api_key|token)\s*=\s*['\"][^'\"]+['\"]" engine/ --include="*.gd" --include="*.cs" | grep -v "test" | grep -v "example"; then
            echo "è­¦å‘Š: å‘ç°å¯èƒ½çš„ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯"
            exit 1
          fi

          echo "æœªå‘ç°æ˜æ˜¾çš„æ•æ„Ÿä¿¡æ¯ âœ“"

  # æ±‡æ€»ç»“æœ
  ci-summary:
    name: CI æ£€æŸ¥æ±‡æ€»
    runs-on: ubuntu-latest
    needs: [gdscript-check, csharp-build, godot-project-check, file-structure-check, documentation-check, security-check]
    if: always()
    steps:
      - name: æ£€æŸ¥æ‰€æœ‰ä»»åŠ¡çŠ¶æ€
        run: |
          echo "=========================================="
          echo "  CI æ£€æŸ¥æ±‡æ€»"
          echo "=========================================="
          echo ""
          echo "âœ“ GDScript æ£€æŸ¥: ${{ needs.gdscript-check.result }}"
          echo "âœ“ C# ç¼–è¯‘æ£€æŸ¥: ${{ needs.csharp-build.result }}"
          echo "âœ“ Godot é¡¹ç›®æ£€æŸ¥: ${{ needs.godot-project-check.result }}"
          echo "âœ“ æ–‡ä»¶ç»“æ„æ£€æŸ¥: ${{ needs.file-structure-check.result }}"
          echo "âœ“ æ–‡æ¡£æ£€æŸ¥: ${{ needs.documentation-check.result }}"
          echo "âœ“ å®‰å…¨æ£€æŸ¥: ${{ needs.security-check.result }}"
          echo ""
          echo "=========================================="

          # æ³¨æ„äº‹é¡¹
          echo ""
          echo "ğŸ“ æ³¨æ„äº‹é¡¹:"
          echo "- CI ç¯å¢ƒä¸åŒ…å« GDCubism æ’ä»¶ï¼ˆæ’ä»¶ä¸æäº¤åˆ°ä»“åº“ï¼‰"
          echo "- ä¾èµ–æ’ä»¶çš„ä»£ç åœ¨ CI ä¸­ä¼šæœ‰è­¦å‘Šï¼Œè¿™æ˜¯æ­£å¸¸çš„"
          echo "- ä¸Šè¿°æ£€æŸ¥ä¸“æ³¨äºå¯åœ¨æ— æ’ä»¶ç¯å¢ƒä¸‹éªŒè¯çš„å†…å®¹"
          echo ""

      - name: éªŒè¯å…³é”®æ£€æŸ¥é€šè¿‡
        if: |
          needs.gdscript-check.result != 'success' ||
          needs.csharp-build.result != 'success' ||
          needs.godot-project-check.result != 'success' ||
          needs.file-structure-check.result != 'success'
        run: |
          echo "âŒ å…³é”®æ£€æŸ¥æœªé€šè¿‡ï¼Œè¯·ä¿®å¤åé‡æ–°æäº¤"
          echo ""
          echo "å¤±è´¥çš„æ£€æŸ¥:"
          [ "${{ needs.gdscript-check.result }}" != "success" ] && echo "  - GDScript æ£€æŸ¥"
          [ "${{ needs.csharp-build.result }}" != "success" ] && echo "  - C# ç¼–è¯‘æ£€æŸ¥"
          [ "${{ needs.godot-project-check.result }}" != "success" ] && echo "  - Godot é¡¹ç›®æ£€æŸ¥"
          [ "${{ needs.file-structure-check.result }}" != "success" ] && echo "  - æ–‡ä»¶ç»“æ„æ£€æŸ¥"
          exit 1

      - name: æ£€æŸ¥é€šè¿‡
        if: |
          needs.gdscript-check.result == 'success' &&
          needs.csharp-build.result == 'success' &&
          needs.godot-project-check.result == 'success' &&
          needs.file-structure-check.result == 'success'
        run: |
          echo ""
          echo "ğŸ‰ æ‰€æœ‰å…³é”®æ£€æŸ¥é€šè¿‡ï¼"
          echo ""

